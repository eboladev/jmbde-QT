<?xml version="1.0" encoding="UTF-8"?>
<!-- Add xmlns:util namespace definition to be able to use stuff from WixUtilExtension dll-->
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
		xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
	<!-- This is how we include wxi files -->
	<?include $(sys.CURRENTDIR)..\jmbde\Install\WiX\Includes\jmbdeVariables.wxi ?>

	<!--
	Id="*" is to enable upgrading. * means that product ID will be autogenerated on each build.
	Name is made of localized product nama and version number.
	-->
	<Product Id="*" Name="!(loc.ProductName) $(var.VersionNumber)" Language="!(loc.Language)"
	 Version="$(var.VersionNumber)"
	 Manufacturer="!(loc.Manufacturer)"
	 UpgradeCode="$(var.UpgradeCode)">

		<!--
			Define the minimum supported installer version (3.0) and that the install should
			be done for the whole machine not just the current user
		-->
		<Package InstallerVersion="300" Compressed="yes" InstallScope="perMachine"/>
		<Media Id="1" Cabinet="media1.cab" EmbedCab="yes" />

		<Property Id="ARPPRODUCTION" Value="!(loc.Manufacturer)" />
		<Property Id="ARPHELPLINK" Value="http://www.juergen-muelbert.de/products/jmbde" />
		<Property Id="ARPURLINFOABOUT" Value="http://www.juergen-muelbert.de" />
		<Property Id="ARPNOREPAIR" Value="1" />
		<Property Id="ARPNOMODIFY" Value="1" />

		<CustomAction Id="NewerVersionFound" Error="!(loc.FormNewerVersionInstalled)" />

		<InstallExecuteSequence>
			<!--
				Check for newer versions with FindRelatedProducts and execute the custom action after it
			-->
			<Custom Action="NewerVersionFound" After="FindRelatedProducts">
				<![CDATA[NEWER_VERSION_FOUND]]>
			</Custom>
			<!--
				Remove the prevoius version of the the product
			-->
			<RemoveExistingProducts After="InstallInitialize" />
			<!--
				WixCloseApplications is a built in custom that uses util:CloseApplication below
			-->
			<Custom Action="WixCloseApplications" Before="InstallInitialize" />
		</InstallExecuteSequence>
		<!--
			This will ask the user to close the Application if it's running while upgrading
		-->
		<util:CloseApplication Id="CloseApplication" CloseMessage="no" Description="!(loc.MustCloseForm)"
				ElevatedCloseMessage="no" RebootPrompt="no" Target="$(var.ExeProcessName)" />

		<Directory Id='TARGETDIR' Name='SourceDir'>
			<Directory Id='ProgramFilesFolder' Name='PFiles'>
				<Directory Id='INSTALLDIR' Name='jmbde'>
					<Component Id='MainExecutable' Guid='{8289278B-9B60-4964-A757-9CF5E21F31D0}'>
						<File Id='jmbdeEXE'
							  Name='jmbde.exe'
							  DiskId='1'
							  Source='..\build-jmbde-Desktop_Qt_5_1_1_MSVC2012_32bit-Release\src\release\jmbde.exe'
							  KeyPath='yes'>
							<Shortcut Id='startMenuJMBDE' Directory='ProgramMenuDir' Name='jmbde'
								WorkingDirectory='INSTALLDIR' Icon='jmbde.ico' IconIndex='0' Advertise='yes' />
							<Shortcut Id='desktopJMBDE' Directory='DesktopFolder' Name='jmbde'
								WorkingDirectory='INSTALLDIR' Icon='jmbde.ico' IconIndex='0' Advertise='yes' />
						</File>
					</Component>
				<Directory Id='PLATFORMSDIR' Name='platforms' />
				<Directory Id='SQLDRIVERSDIR' Name='sqldrivers' />
				<Directory Id='TRANSLATIONS' Name='translations'>
					<Component Id='Translations' Guid='{8A6B3937-2706-4f2b-A63E-8BF0F6E067F8}'>
						<File Id='de'
							Name='jmbde_de.qm'
							Source='..\jmbde\src\translations\jmbde_de.qm' />
						<File Id='es'
							Name='jmbde_es.qm'
							Source='..\jmbde\src\translations\jmbde_es.qm' />
						<File Id='it'
							Name='jmbde_it.qm'
							Source='..\jmbde\src\translations\jmbde_it.qm' />
					</Component>
				</Directory>
				<Directory Id='IMAGES' Name='images'>
					<Component Id='Images' Guid='{01D87576-5452-4ed1-8568-BA99B85EFC95}'>
						<File Id='ContactNew'
							Name='contact-new.png'
							Source='..\jmbde\src\images\contact-new.png' />
						<File Id='DocumentNew'
							Name='document-new.png'
							Source='..\jmbde\src\images\document-new.png' />
						<File Id='HelpBrowser'
							Name='help-browser.png'
							Source='..\jmbde\src\images\help-browser.png' />
					</Component>
				</Directory>
				<Directory Id="HELP" Name="help">
					<Component Id="Help" Guid="{574975B5-C22C-4dab-A634-BF9471FC167B}">
						<File Id="qhcp"
							Name="jmbde.qhcp"
							Source="..\jmbde\src\help\jmbde.qhcp" />
						<File Id="qhp"
							Name="jmbde.qhp"
							Source="..\jmbde\src\help\jmbde.qhp" />
					</Component>
				</Directory>
			</Directory>
		</Directory>
			<Directory Id='ProgramMenuFolder' Name='Program'>
				<Directory Id='ProgramMenuDir' Name='jmbde'>
					<Component Id='ProgramMenuDir' Guid='{31889827-47FD-4128-A363-27FA6CEE9932}'>
						<RemoveFolder Id='ProgramMenuDir' On='uninstall' />
 						<RegistryValue Root='HKCU' Key='Software\[Manufacturer]\[ProductName]' Type='string' Value='' KeyPath='yes'/>
 					</Component>
				</Directory>
			</Directory>
			<Directory Id='DesktopFolder' Name='Desktop' />
		</Directory>

		<Feature Id='Complete' Title="jmbde" Description='The complete package'
			Display='expand' ConfigurableDirectory='INSTALLDIR' Level='1'>
			<Feature Id='MainProgram' Title="!(loc.FeatureTitle)" Description='The main executable' Level='1'>
				<ComponentRef Id='MainExecutable' />
				<ComponentRef Id='ProgramMenuDir' />
				<ComponentRef Id='QT5Runtime' />
				<ComponentRef Id='QT5Platforms' />
				<ComponentRef Id='QT5Sql' />
				<ComponentRef Id='QT5Sqlite' />
				<ComponentRef Id='Images' />
				<ComponentRef Id="Translations" />
			</Feature>
			<Feature Id='Help' Title='Help' Description='The Help Documents' Level='1000'>
				<ComponentRef Id="Help"/>
			</Feature>
		</Feature>

		<!-- Use the built in WixUI_InstallDir GUI -->

		<UI>
			<!-- These dialog references are needed for CloseApplication above to work correctly -->
			<DialogRef Id="FilesInUse" />
			<DialogRef Id="MsiRMFilesInUse" />
			<!-- Here we'll add the GUI logic for installation. -->
		</UI>

		<!-- Set the icon to show next to the program name in Add/Remove program -->
		<Icon Id='jmbde.ico' SourceFile="$(var.ResourcesDir)\jmbde.ico" />

 		<UIRef Id="WixUI_Mondo" />
 		<UIRef Id="WixUI_ErrorProgressText" />
		<WixVariable Id="WixUILicenseRtf" Value="$(var.ResourcesDir)\License.rtf" />
	</Product>
</Wix>